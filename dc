#!/bin/bash
##################################
######### DESCRIPTION ############
##################################
# Provides the following main functions:
# - up      - bring up all stacks, an individual stack or a container
# - down    - brings down all stacks or an individual stack
# - stop    - stops all stacks, an individual stack, or a container
# - restart - restart all stacks, a stack, or a container
# - network - create the macvlan network that is needed
# - list    - lists all stacks and services in the stack
##################################
###### VARIABLES
if [[ -z "${DC_DIR}" ]]; then
    export DC_DIR="${HOME}/docker"
else
    export DC_DIR="${DC_DIR}"
fi
export ENV="${DC_DIR}/.env"
export DC_CMD=`which docker-compose`
export DC_COMMAND="${DC_CMD} --env-file ${ENV}"

# COLORS
export RED='\033[0;31m'
export NC='\033[0m' # No Color

###### FUNCTIONS
# USAGE
function show_usage (){
    printf "Usage: $0 [options [parameters]]\n"
    printf "\n"
    printf "Options:\n"
    printf " ${RED}up${NC}        Bring up a stack\n"
    printf " ${RED}down${NC}      Bring down a stack\n"
    printf " ${RED}start${NC}     Start one or more containers\n"
    printf " ${RED}stop${NC}      Stop one or more containers\n"
    printf " ${RED}restart${NC}   Restart one or more containers\n"
    printf " ${RED}network${NC}   Create the MacVLAN network\n"
    printf " ${RED}list${NC}      List stacks and services in the stack\n"
    printf " ${RED}help${NC}      Print help\n"

return 0
}

# UP
function up () {
    if [ -z "$1" ]; then
        echo "No argument provided, please use the name of a stack or all"
    elif [ "$1" == "all" ]; then
        echo "Bringing up all stacks"
        for stack in $(find ${DC_DIR} -name docker-compose.yml -printf '%h\n' | sort -u);
        do
            echo -e "\n$stack:"
            cd $stack
            ${DC_COMMAND} up -d
            cd - > /dev/null
        done
    else
        for stack in $@;
        do
            STACK="${DC_DIR}/$stack"
            echo "Bringing up stack(s) $stack"
            cd ${STACK}
            ${DC_COMMAND} up -d
            cd - > /dev/null
        done
    fi
    }

# DOWN
function down(){
    if [ -z "$1" ]; then
        echo "No argument provided, please use the name of a stack or all"
    elif [ "$1" == "all" ]; then
        echo "Bringing down all stacks"
        for stack in $(find ${DC_DIR} -name docker-compose.yml -printf '%h\n' | sort -ur);
        do
            echo -e "\n$stack:"
            cd $stack
            ${DC_COMMAND} down
            cd - > /dev/null
        done
    else
        for stack in $@;
        do
            STACK="${DC_DIR}/$stack"
            echo "Bringing down stack(s) $stack"
            cd ${STACK}
            ${DC_COMMAND} down
            cd - > /dev/null
        done
    fi
    }

# START
function start(){
    echo "Starting the following container(s):"
    echo "${DC_COMMAND} start "
    }

# STOP
# Stop also removes the image
function stop(){
    echo "Stopping the following container(s):"
    echo "${DC_COMMAND} stop "
    }

# RESTART
# Restart is basically a stop and start in sequence
function restart(){
    echo "restart"
    stop
    start
    }

# NETWORK
function network(){
    echo "network"
    }

# LIST
function list(){
    echo "Listing Stacks and Services"
    for stack in $(find ${DC_DIR} -name docker-compose.yml -printf '%h\n' | sort -u);
    do
        STACK_NAME=$(echo $stack | rev | cut -d / -f 1 | rev)
        echo "-----------------------------------"
        printf "Stack ${RED}${STACK_NAME}${NC} contains services:\n"
        cd $stack
        ${DC_COMMAND} ps --services -a
        cd - > /dev/null
    done
    }

###### CASES
case ${1} in
# ----------- up ------------
    "up")
        up ${@:2}
        ;;

# ----------- down ------------
    "down")
        down ${@:2}
        ;;

# ----------- start ------------
    "start")
        start ${@:2}
        ;;

# ----------- stop ------------
    "stop")
        stop ${@:2}
        ;;

# ----------- restart ------------
    "restart")
        restart ${@:2}
        ;;

# ----------- network ------------
    "network")
        network
        ;;

# ----------- list ------------
    "list")
        list
        ;;


    *)
        show_usage
        ;;
esac
